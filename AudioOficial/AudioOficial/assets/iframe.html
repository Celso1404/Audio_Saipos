<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AudioZendesk</title>
</head>
<body>
  <h3>AudioZendesk</h3>

  <button id="startBtn">Iniciar Gravação</button>
  <button id="stopBtn" disabled>Parar Gravação</button>
  <br><br>

  <audio id="audioPlayer" controls style="display:none;"></audio>
  <br><br>

  <button id="sendWhatsAppBtn" disabled>Enviar para WhatsApp</button>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioUrlFromServer = null;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const audioPlayer = document.getElementById('audioPlayer');
    const sendWhatsAppBtn = document.getElementById('sendWhatsAppBtn');

    // Inicia gravação
    startBtn.addEventListener('click', async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      audioChunks = [];
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/ogg' });
        const audioUrl = URL.createObjectURL(audioBlob);
        audioPlayer.src = audioUrl;
        audioPlayer.style.display = "block";

        // Upload para backend
        const formData = new FormData();
        formData.append("audio", audioBlob, "gravacao.ogg");

        try {
          const res = await fetch("http://localhost:3000/upload", {
            method: "POST",
            body: formData
          });
          const data = await res.json();

          if (data.downloadUrl) {
            audioUrlFromServer = data.downloadUrl;
            sendWhatsAppBtn.disabled = false; // habilita botão
          }
        } catch (err) {
          console.error("Erro no upload:", err);
        }
      };

      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    });

    // Para gravação
    stopBtn.addEventListener('click', () => {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    // Envia áudio para WhatsApp
    sendWhatsAppBtn.addEventListener('click', async () => {
      if (!audioUrlFromServer) {
        alert("Nenhum áudio disponível para enviar.");
        return;
      }

      try {
        const res = await fetch("http://localhost:3000/send-whatsapp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            to: "5511999999999", // número de destino
            audioUrl: audioUrlFromServer
          })
        });

        const data = await res.json();
        console.log("Resposta WhatsApp:", data);
        alert("Áudio enviado com sucesso!");
      } catch (err) {
        console.error("Erro ao enviar para WhatsApp:", err);
      }
    });
  </script>
</body>
</html>
